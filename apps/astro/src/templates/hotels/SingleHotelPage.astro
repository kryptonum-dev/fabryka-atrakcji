---
import Layout from '@/src/layouts/Layout.astro'
import type { Language } from '@/global/languages'
import { getLangFromPath } from '@/src/global/languages'
import Breadcrumbs from '@/src/layouts/Breadcrumbs.astro'
import sanityFetch from '@/src/utils/sanity.fetch'
import metadataFetch from '@/src/utils/metadata.fetch'
import { ImageDataQuery, type ImageDataProps } from '@/src/components/ui/image'
import { PortableTextQuery, type PortableTextValue } from '@/src/components/ui/portable-text'
import Components, { Components_Query, type ComponentsProps } from '@/src/components/Components.astro'
import Hero from '@/src/components/offer/Hero.astro'
import ContentPT, { type Props as ContentPTProps, ContentPT_Query } from '@/src/components/ui/content-pt/index.astro'
import Faq, { Faq_Query } from '@/src/components/ui/content-pt/offer/Faq.astro'
import Testimonials, { Testimonials_Query } from '@/src/components/ui/content-pt/offer/Testimonials.astro'
import Amenities, { Amenities_Query } from '@/src/components/ui/content-pt/hotel/Amenities.astro'
import Location, { Location_Query } from '@/src/components/ui/content-pt/hotel/Location.astro'
import StayingRules, { StayingRules_Query } from '@/src/components/ui/content-pt/hotel/StayingRules.astro'
import Checklist, { Checklist_Query } from '@/src/components/ui/content-pt/shared/Checklist.astro'
import BlocksWithImage, { BlocksWithImage_Query } from '@/src/components/ui/content-pt/offer/BlocksWithImage.astro'
import ImageWithHeadingAndText, {
  ImageWithHeadingAndText_Query,
} from '@/src/components/ui/content-pt/offer/ImageWithHeadingAndText.astro'
import RowsWithIcons, { RowsWithIcons_Query } from '@/src/components/ui/content-pt/offer/RowsWithIcons.astro'
import Timeline, { Timeline_Query } from '@/src/components/ui/content-pt/offer/Timeline.astro'
import NextSteps, { NextSteps_Query } from '@/src/components/ui/content-pt/offer/NextSteps.astro'
import ContactForm from '@/src/components/global/ContactForm/index.astro'
import type { BaseHotelProps, FormStateTypes } from '@/src/global/types'
import Image, { Image_Query } from '@/src/components/ui/content-pt/shared/Image.astro'

export type SingleHotelProps = BaseHotelProps & {
  globalFormDefaults?: {
    heading?: PortableTextValue
    paragraph?: PortableTextValue
  }
  hotelsPage: {
    name: string
    slug: string
    detailFormDefaults?: {
      heading?: PortableTextValue
      paragraph?: PortableTextValue
      formVisualImage?: ImageDataProps
      overrideFormState?: boolean
      formState?: FormStateTypes
    }
  }
  _type: 'Hotels_Collection'
  mediaList?: Array<{
    image: ImageDataProps
    youtubeId?: string
  }>
  formOverrides?: {
    heading?: PortableTextValue
    paragraph?: PortableTextValue
    formVisualImage?: ImageDataProps
    overrideFormState?: boolean
    formState?: FormStateTypes
  }
  components: ComponentsProps
  content: ContentPTProps['value']
}

export async function fetchData(slug: string, lang: Language) {
  const prefixes = {
    pl: '/pl/hotele/',
    en: '/en/hotels/',
  }

  const page = await sanityFetch<SingleHotelProps>({
    query: `
    *[_type == 'Hotels_Collection' && language == $language && slug.current == $slug][0] {
      _id,
      "globalFormDefaults": *[_type == "global" && language == $language][0].inquiryFormDefaults {
        ${PortableTextQuery('heading')}
        ${PortableTextQuery('paragraph')}
      },
      "hotelsPage": *[_type == "Hotels_Page" && language == $language][0] {
        name,
        "slug": slug.current,
        detailFormDefaults {
          ${PortableTextQuery('heading')}
          ${PortableTextQuery('paragraph')}
          ${ImageDataQuery('formVisualImage')}
          overrideFormState,
          formState {
            success {
              ${PortableTextQuery('heading')}
              ${PortableTextQuery('paragraph')}
              highlightedSocialMedia[] -> {
                name,
                link,
                iconString,
              },
            },
            error {
              ${PortableTextQuery('heading')}
              ${PortableTextQuery('paragraph')}
            },
          },
        },
      },
      _type,
      name,
      "slug": slug.current,
      ${PortableTextQuery('title')}
      description,
      mediaList[]{
        ${ImageDataQuery('image')}
        youtubeId
      },
      ${ImageDataQuery('imageList[]')}
      amenities[]->{
        _id,
        name,
      },
      location->{
        _id,
        name
      },
      stars,
      numberOfRooms,
      maxPeople,
      address,
      googleMaps{
        googleMapsLink,
      },
      popularityIndex,
      pricing,
      ${ContentPT_Query([Faq_Query, Image_Query, Testimonials_Query, Amenities_Query, Location_Query, StayingRules_Query, Checklist_Query, BlocksWithImage_Query, ImageWithHeadingAndText_Query, RowsWithIcons_Query, Timeline_Query, NextSteps_Query])}
      formOverrides {
        ${PortableTextQuery('heading')}
        ${PortableTextQuery('paragraph')}
        ${ImageDataQuery('formVisualImage')}
        overrideFormState,
        formState {
          success {
            ${PortableTextQuery('heading')}
            ${PortableTextQuery('paragraph')}
            highlightedSocialMedia[] -> {
              name,
              link,
              iconString,
            },
          },
          error {
            ${PortableTextQuery('heading')}
            ${PortableTextQuery('paragraph')}
          },
        },
      },
      ${Components_Query}
    }
  `,
    params: { language: lang, slug: `${prefixes[lang]}${slug}/` },
  })

  if (!page) return null

  const metadata = await metadataFetch(page.slug)

  if (!metadata) return null

  return {
    page,
    metadata,
  }
}

export async function staticPaths(lang: Language) {
  const pages = await sanityFetch<{ slug: string }[]>({
    query: `
      *[_type == 'Hotels_Collection' && language == $language][] {
        "slug": slug.current,
      }
    `,
    params: { language: lang },
  })
  return pages?.map(({ slug }) => ({
    params: { slug: slug.split('/').slice(-2).join('/') },
  }))
}

const { page, metadata } = Astro.props as NonNullable<Awaited<ReturnType<typeof fetchData>>>
const lang = (getLangFromPath(Astro.url.pathname) as Language) || 'pl'

const formHeading = page.formOverrides?.heading || page.hotelsPage.detailFormDefaults?.heading || page.globalFormDefaults?.heading
const formParagraph =
  page.formOverrides?.paragraph || page.hotelsPage.detailFormDefaults?.paragraph || page.globalFormDefaults?.paragraph
const formVisualImage = page.formOverrides?.formVisualImage || page.hotelsPage.detailFormDefaults?.formVisualImage
const resolvedOverrideFormState = page.formOverrides?.overrideFormState ?? page.hotelsPage.detailFormDefaults?.overrideFormState
const resolvedFormState = page.formOverrides?.overrideFormState
  ? page.formOverrides?.formState
  : page.hotelsPage.detailFormDefaults?.formState
const filteredComponents = (page.components || []).filter((c) => c._type !== 'ContactForm')
---

<Layout {...metadata}>
  <Breadcrumbs
    data={[
      { name: page.hotelsPage.name, path: page.hotelsPage.slug },
      { name: page.name, path: page.slug },
    ]}
    firstItemType="OfferHero"
  />
  <Hero {...page} _type="Hotels_Collection" />

  <article class="wrapper max-width" id="content">
    <div class="content">
      <ContentPT
        value={page.content}
        additionalComponents={{
          Faq,
          Testimonials,
          Amenities,
          Location,
          StayingRules,
          Checklist,
          BlocksWithImage,
          ImageWithHeadingAndText,
          RowsWithIcons,
          Timeline,
          NextSteps,
          Image,
        }}
      />
    </div>
  </article>
  {formHeading && (
    <ContactForm
      index={10}
      sectionId={lang === 'pl' ? 'kontakt' : 'contact'}
      heading={formHeading}
      paragraph={formParagraph || []}
      formVisualImage={formVisualImage}
      overrideFormState={resolvedOverrideFormState}
      state={resolvedFormState}
      variant="hotel_detail"
      showInquiries={false}
      animate={false}
      contextItem={{ type: 'hotel', id: page._id, name: page.name }}
    />
  )}
  <Components data={filteredComponents} hasPreviousSections />
</Layout>

<style lang="scss">
  .wrapper {
    display: grid;
    grid-template-columns: auto 1fr;
    justify-content: space-between;
    gap: 1.5rem;
    padding: clamp(3rem, calc(3.5vw / 0.48), 3.5rem) 0;

    .content {
      max-width: clamp(20rem, calc(25vw / 0.48), 40.9375rem);
      justify-self: start;

      :global(> :first-child) {
        margin-top: 0;

        :global(> :first-child) {
          margin-top: 0 !important;
        }
      }

      :global(> :last-child) {
        margin-bottom: 0;
      }

      :global(strong:not(h1 strong, h2 strong)) {
        font-weight: 700;
        color: var(--primary-800, #45051c);
      }

      :global(> p),
      :global(> ul),
      :global(> ol),
      :global(> ul li),
      :global(> ol li),
      :global(> ul p),
      :global(> ol p) {
        font-size: var(--typography-body-xl, 1.125rem);
        line-height: 1.5;
        margin-bottom: clamp(0.625rem, calc(0.75vw / 0.48), 0.75rem);
      }

      :global(> h2) {
        margin: clamp(3rem, calc(3.25vw / 0.48), 3.25rem) 0 1.5rem;
        font-size: var(--typography-heading-l);
      }

      :global(> h3) {
        color: var(--primary-700, #600d2a);
        font-size: var(--typography-body-2xl, 1.5rem);
        line-height: 1.25;
        margin: 1.5rem 0 1rem;
        letter-spacing: -0.04em;
        font-variant-numeric: lining-nums proportional-nums;

        font-weight: 700;
        font-family: 'Neue Haas Unica', 'Neue Haas Unica Fallback', sans-serif;
      }

      :global(li:last-child) {
        margin-bottom: 0;
      }
    }

    .pricing {
      background: var(--neutral-200, #f5f1ec);
      border-radius: 0.75rem;
      max-width: 27.0625rem;
      width: 100%;
      padding: 1.5rem;
      height: 15.625rem;
      justify-self: end;
      position: sticky;
      top: 89px;
      max-height: calc(100vh - 89px);
    }

    @media (max-width: 68.0625rem) {
      grid-template-columns: 1fr;
      justify-items: center;
      max-width: 48rem;
      padding-top: 0;
      gap: 0;
      .pricing {
        grid-row: 1/2;
        position: static;
        max-width: 100%;
      }
      .content {
        grid-row: 2/3;
        max-width: 100%;
        padding-top: clamp(3rem, calc(3.5vw / 0.48), 3.5rem);
      }
    }
  }
</style>

<script>
  import { trackEvent } from '@/utils/track-event'

  // Track hotel view event
  document.addEventListener('DOMContentLoaded', () => {
     // Get hotel information
     const containerEl = document.querySelector('.Hero') as HTMLElement
     const hotelId = containerEl?.dataset.id || ''
     const hotelName = containerEl?.dataset.name || ''
    const price = containerEl?.getAttribute('data-price') || ''
    const priceValue = Number(price) || undefined
 
     // Track view_item event
     trackEvent({
      ga4: {
        eventName: 'view_item',
        params: {
          currency: 'PLN',
          value: priceValue,
          items: [
            {
              item_id: hotelId,
              item_name: hotelName,
              price: priceValue,
            },
          ],
        },
      },
      meta: {
        eventName: 'ViewContent',
        contentName: hotelName || document.title,
        params: {
          content_ids: hotelId ? [hotelId] : undefined,
          content_type: 'hotel',
          value: priceValue,
          currency: priceValue ? 'PLN' : undefined,
        },
      },
    })
  })
</script>
